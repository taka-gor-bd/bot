<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnBot - Telegram Earning System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOEZ-yOQA0P_ZRHG5ppvz1UpnYGN-MMXM",
            authDomain: "earnhub-a58e5.firebaseapp.com",
            databaseURL: "https://earnhub-a58e5-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "earnhub-a58e5",
            storageBucket: "earnhub-a58e5.firebasestorage.app",
            messagingSenderId: "644080542691",
            appId: "1:644080542691:web:dae120e0f671f991cf36d6",
            measurementId: "G-G7CJZ0BV0K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseIncrement = increment;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            color: var(--tg-theme-text-color, #000);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--tg-theme-secondary-bg-color, rgba(255,255,255,0.95));
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: var(--tg-theme-hint-color, #666);
            font-size: 14px;
            opacity: 0.8;
        }
        
        .user-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .user-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .user-id {
            font-size: 12px;
            opacity: 0.6;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f1f3f4);
            color: var(--tg-theme-text-color, #000);
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .referral-section {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            border: 1px dashed rgba(102, 126, 234, 0.3);
        }
        
        .referral-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .referral-link {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #f5c6cb;
        }

        .ad-timer {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f1f3f4;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">🎉 EarnBot</div>
            <div class="subtitle">Telegram Referral Earning System</div>
        </div>
        
        <div id="userInfo" class="user-info">
            <div class="loading"></div>
            <div style="margin-top: 10px;">Loading user data...</div>
        </div>
        
        <div id="messageContainer"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="points">0</div>
                <div class="stat-label">💰 Points</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="referrals">0</div>
                <div class="stat-label">👥 Referrals</div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" id="watchAdBtn" onclick="watchAd()">
                👀 Watch Ad (+5 Points)
            </button>
            <button class="btn btn-secondary" onclick="shareReferral()">
                📤 Share Referral Link
            </button>
            <button class="btn btn-secondary" onclick="viewTasks()">
                ✅ Complete Tasks (+10 Points)
            </button>
            <button class="btn btn-secondary" onclick="checkStats()">
                📊 Refresh Stats
            </button>
        </div>
        
        <div class="referral-section">
            <div class="referral-title">🔗 Your Referral Link</div>
            <div id="referralLink" class="referral-link">Loading...</div>
            <button class="btn btn-secondary" onclick="copyReferralLink()">
                📋 Copy Link
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let tg = window.Telegram?.WebApp;
        let user = null;
        let currentUserData = {
            points: 0,
            referrals: 0,
            adsWatched: 0,
            tasksCompleted: 0
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            initializeTelegramWebApp();
            await loadUserData();
            updateReferralLink();
        });
        
        function initializeTelegramWebApp() {
            if (tg) {
                tg.ready();
                tg.expand();
                user = tg.initDataUnsafe?.user;
                
                // Apply Telegram theme
                document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.body.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.body.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
                document.body.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                document.body.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f1f3f4');
                document.body.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#666666');
            } else {
                // Fallback for testing outside Telegram
                user = {
                    id: 123456789,
                    first_name: "Test User",
                    username: "testuser"
                };
            }
        }
        
        async function loadUserData() {
            const userInfoDiv = document.getElementById('userInfo');
            
            if (user) {
                userInfoDiv.innerHTML = `
                    <div class="user-name">Welcome, ${user.first_name}! 👋</div>
                    <div class="user-id">ID: ${user.id}</div>
                `;
                
                try {
                    // Try to load user data from Firebase
                    if (window.firebaseDB) {
                        const userRef = window.firebaseDoc(window.firebaseDB, 'users', user.id.toString());
                        const userDoc = await window.firebaseGetDoc(userRef);
                        
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            currentUserData = {
                                points: userData.points || 0,
                                referrals: userData.referralCount || 0,
                                adsWatched: userData.adsWatched || 0,
                                tasksCompleted: userData.tasksCompleted || 0
                            };
                        } else {
                            // Create new user
                            await window.firebaseSetDoc(userRef, {
                                telegramId: user.id,
                                username: user.username || '',
                                firstName: user.first_name || '',
                                lastName: user.last_name || '',
                                points: 0,
                                referralCount: 0,
                                adsWatched: 0,
                                tasksCompleted: 0,
                                createdAt: window.firebaseServerTimestamp(),
                                updatedAt: window.firebaseServerTimestamp()
                            });
                        }
                    }
                } catch (error) {
                    console.error('Firebase error:', error);
                    // Continue with local data
                }
                
                updateStats();
            } else {
                userInfoDiv.innerHTML = `
                    <div class="user-name">Welcome to EarnBot! 🎉</div>
                    <div class="user-id">Demo Mode</div>
                `;
            }
        }
        
        function updateStats() {
            document.getElementById('points').textContent = currentUserData.points;
            document.getElementById('referrals').textContent = currentUserData.referrals;
        }
        
        function updateReferralLink() {
            const botUsername = 'YourBotUsername'; // Replace with your actual bot username
            const referralLink = `https://t.me/${botUsername}?start=${user?.id || '123456'}`;
            document.getElementById('referralLink').textContent = referralLink;
        }
        
        function showMessage(message, type = 'success') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                container.removeChild(messageDiv);
            }, 3000);
        }
        
        async function watchAd() {
            const btn = document.getElementById('watchAdBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Watching Ad...';
            
            // Simulate ad watching with countdown
            let countdown = 5;
            const timer = setInterval(() => {
                btn.innerHTML = `⏰ Please wait ${countdown}s...`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timer);
                    completeAdWatch();
                }
            }, 1000);
        }
        
        async function completeAdWatch() {
            const btn = document.getElementById('watchAdBtn');
            
            try {
                // Update local data
                currentUserData.points += 5;
                currentUserData.adsWatched += 1;
                updateStats();
                
                // Update Firebase
                if (window.firebaseDB && user) {
                    const userRef = window.firebaseDoc(window.firebaseDB, 'users', user.id.toString());
                    await window.firebaseUpdateDoc(userRef, {
                        points: window.firebaseIncrement(5),
                        adsWatched: window.firebaseIncrement(1),
                        updatedAt: window.firebaseServerTimestamp()
                    });
                }
                
                showMessage('🎉 You earned 5 points for watching an ad!');
                
                if (tg) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } catch (error) {
                console.error('Error updating points:', error);
                showMessage('⚠️ Error updating points. Try again later.', 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '👀 Watch Ad (+5 Points)';
        }
        
        function shareReferral() {
            const botUsername = 'YourBotUsername'; // Replace with your actual bot username
            const referralLink = `https://t.me/${botUsername}?start=${user?.id || '123456'}`;
            const text = `🎉 Join EarnBot and start earning points! Use my referral link: ${referralLink}`;
            
            if (tg) {
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent('🎉 Join EarnBot and earn points!')}`);
            } else if (navigator.share) {
                navigator.share({
                    title: 'Join EarnBot!',
                    text: text,
                    url: referralLink
                });
            } else {
                copyReferralLink();
            }
        }
        
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(referralLink).then(() => {
                    showMessage('📋 Referral link copied to clipboard!');
                    if (tg) {
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = referralLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('📋 Referral link copied!');
            }
        }
        
        async function viewTasks() {
            // Simulate completing a task
            try {
                currentUserData.points += 10;
                currentUserData.tasksCompleted += 1;
                updateStats();
                
                // Update Firebase
                if (window.firebaseDB && user) {
                    const userRef = window.firebaseDoc(window.firebaseDB, 'users', user.id.toString());
                    await window.firebaseUpdateDoc(userRef, {
                        points: window.firebaseIncrement(10),
                        tasksCompleted: window.firebaseIncrement(1),
                        updatedAt: window.firebaseServerTimestamp()
                    });
                }
                
                showMessage('✅ Task completed! You earned 10 points!');
                
                if (tg) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                showMessage('⚠️ Error completing task. Try again later.', 'error');
            }
        }
        
        async function checkStats() {
            try {
                await loadUserData();
                showMessage('📊 Stats refreshed successfully!');
            } catch (error) {
                showMessage('⚠️ Error refreshing stats.', 'error');
            }
        }
    </script>
</body>
</html>